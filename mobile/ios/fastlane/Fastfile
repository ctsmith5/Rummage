default_platform(:ios)

platform :ios do
  desc "Build a release IPA and upload to TestFlight"
  lane :testflight do |options|
    build_number = (options[:build_number] || ENV["GITHUB_RUN_NUMBER"] || Time.now.to_i.to_s).to_s
    app_identifier = ENV["APP_IDENTIFIER"] || "com.RummageApp.Rummage"
    team_id = ENV["APPLE_TEAM_ID"] || "2779EQ3QB6"

    api_key = app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_API_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_API_ISSUER_ID"),
      key_content: ENV.fetch("APP_STORE_CONNECT_API_KEY_P8")
    )

    # Create/unlock a temporary keychain on CI so certs can be imported reliably.
    setup_ci

    # Ensure Flutter generates ios/Flutter/Generated.xcconfig before CocoaPods runs.
    Dir.chdir(File.expand_path("../..", __dir__)) do
      sh("flutter", "pub", "get")
      sh("flutter", "precache", "--ios") if is_ci
    end

    # Install certs/profiles for App Store distribution.
    # If the match repo is empty (first run), CI must be able to create and push
    # the signing identity. You can force readonly behavior by setting:
    # MATCH_READONLY=true
    readonly_match = (ENV["MATCH_READONLY"] || "false").to_s.downcase == "true"
    match(
      type: "appstore",
      api_key: api_key,
      app_identifier: app_identifier,
      team_id: team_id,
      readonly: readonly_match
    )

    # Ensure pods are installed (Runner.xcworkspace exists).
    cocoapods(clean_install: true)

    # Build with Fastlane (manual signing via match), avoiding Xcode account prompts.
    gym(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      clean: true,
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "Rummage.ipa",
      export_options: {
        signingStyle: "manual",
        provisioningProfiles: {
          app_identifier => "match AppStore #{app_identifier}",
        },
      }
    )

    ipa_path = File.expand_path("../build/ios/ipa/Rummage.ipa", __dir__)
    UI.user_error!("No IPA found at #{ipa_path}") unless File.exist?(ipa_path)

    pilot(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true
    )
  end
end

