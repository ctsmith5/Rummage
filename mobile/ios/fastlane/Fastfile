default_platform(:ios)

platform :ios do
  desc "Build a release IPA and upload to TestFlight"
  lane :testflight do |options|
    build_number = (options[:build_number] || ENV["GITHUB_RUN_NUMBER"] || Time.now.to_i.to_s).to_s

    api_key = app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_API_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_API_ISSUER_ID"),
      key_content: ENV.fetch("APP_STORE_CONNECT_API_KEY_P8")
    )

    # Install certs/profiles for App Store distribution.
    # If the match repo is empty (first run), CI must be able to create and push
    # the signing identity. You can force readonly behavior by setting:
    # MATCH_READONLY=true
    readonly_match = (ENV["MATCH_READONLY"] || "false").to_s.downcase == "true"
    match(
      type: "appstore",
      api_key: api_key,
      readonly: readonly_match
    )

    # Build via Flutter so we honor pubspec + Flutter build settings.
    Dir.chdir(File.expand_path("../..", __dir__)) do
      sh("flutter", "pub", "get")
      sh("flutter", "build", "ipa", "--release", "--build-number", build_number)
    end

    ipa_glob = File.expand_path("../../build/ios/ipa/*.ipa", __dir__)
    ipa_path = Dir[ipa_glob].sort.last
    UI.user_error!("No IPA found at #{ipa_glob}") if ipa_path.nil?

    pilot(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: true
    )
  end
end

